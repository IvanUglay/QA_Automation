{
  "info": {
    "name": "TheCatAPI - Integration tests (images ↔ favourites ↔ votes)",
    "_postman_id": "thecatapi-integration-tests",
    "description": "Integration tests covering interactions between images, favourites, and votes. Requires X-API-KEY and optional sub_id. Generated by assistant.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {"key": "endpoint", "value": "https://api.thecatapi.com/v1"},
    {"key": "x_api_key", "value": "DEMO-API-KEY"},
    {"key": "sub_id", "value": "integration-test-user-1234"},
    {"key": "image_id", "value": ""},
    {"key": "favourite_id", "value": ""},
    {"key": "vote_id", "value": ""}
  ],
  "item": [
    {
      "name": "1 - GET /images/search (pick image)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/images/search?limit=1",
        "description": "Search and pick one image id for subsequent tests. Saves image_id variable."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () { pm.response.to.have.status(200); });",
              "let json = pm.response.json();",
              "pm.test('Response is array with at least one item', function () { pm.expect(json).to.be.an('array'); pm.expect(json.length).to.be.above(0); });",
              "if (json && json.length>0 && json[0].id) {",
              "  pm.collectionVariables.set('image_id', json[0].id);",
              "  console.log('Saved image_id=', json[0].id);",
              "} else {",
              "  pm.test('Found image id', function () { pm.expect.fail('No image id found in response'); });",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "2 - POST /favourites (create favourite for image)",
      "request": {
        "method": "POST",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"image_id\": \"{{image_id}}\",\n  \"sub_id\": \"{{sub_id}}\"\n}"
        },
        "url": "{{endpoint}}/favourites",
        "description": "Create a favourite for the chosen image. Requires image_id set by request 1."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "if (!pm.collectionVariables.get('image_id')) {",
              "  pm.sendRequest({",
              "    url: pm.collectionVariables.get('endpoint') + '/images/search?limit=1',",
              "    method: 'GET',",
              "    header: { 'x-api-key': pm.collectionVariables.get('x_api_key') }",
              "  }, function(err, res) {",
              "    if (!err && res && res.json() && res.json().length>0) {",
              "      pm.collectionVariables.set('image_id', res.json()[0].id);",
              "      console.log('prereq set image_id=', res.json()[0].id);",
              "    }",
              "  });",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200 or 201', function () { pm.expect(pm.response.code).to.be.oneOf([200,201]); });",
              "let j = pm.response.json();",
              "pm.test('Response has id (favourite id)', function () { pm.expect(j).to.have.property('id'); });",
              "if (j && j.id) pm.collectionVariables.set('favourite_id', j.id);"
            ]
          }
        }
      ]
    },
    {
      "name": "3 - GET /favourites?sub_id=... (verify favourite exists)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/favourites?sub_id={{sub_id}}&limit=10",
        "description": "Verify the created favourite is returned when querying by sub_id."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
              "let arr = pm.response.json();",
              "pm.test('Response is array', function () { pm.expect(arr).to.be.an('array'); });",
              "pm.test('Contains our favourite image_id', function () {",
              "  let found = arr.some(it => it.image_id === pm.collectionVariables.get('image_id'));",
              "  pm.expect(found).to.be.true;",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "4 - POST /votes (create vote for same image)",
      "request": {
        "method": "POST",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"image_id\": \"{{image_id}}\",\n  \"sub_id\": \"{{sub_id}}\",\n  \"value\": 1\n}"
        },
        "url": "{{endpoint}}/votes",
        "description": "Create a vote (value 1) for the chosen image. Saves vote_id."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200 or 201', function () { pm.expect(pm.response.code).to.be.oneOf([200,201]); });",
              "let j = pm.response.json();",
              "pm.test('Response has id (vote_id)', function () { pm.expect(j).to.have.property('id'); });",
              "if (j && j.id) pm.collectionVariables.set('vote_id', j.id);"
            ]
          }
        }
      ]
    },
    {
      "name": "5 - GET /votes?sub_id=... (verify vote exists)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/votes?sub_id={{sub_id}}&limit=10",
        "description": "Verify the created vote appears when querying votes by sub_id."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
              "let arr = pm.response.json();",
              "pm.test('Response is array', function () { pm.expect(arr).to.be.an('array'); });",
              "pm.test('Contains our vote for image_id', function () {",
              "  let found = arr.some(it => it.image_id === pm.collectionVariables.get('image_id') && it.value === 1);",
              "  pm.expect(found).to.be.true;",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "6 - GET /images/{image_id} (check include flags if supported)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/images/{{image_id}}?sub_id={{sub_id}}",
        "description": "Check whether the image endpoint returns favourite/vote info for sub_id. Note: API may or may not include these flags; test is permissive."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
              "let j = pm.response.json();",
              "pm.test('Response has id matching image_id', function () { pm.expect(j.id || j.image_id || (j.data && j.data.id)).to.be.ok; });",
              "pm.test('If votes/favourites included, they reference our sub_id (non-fatal)', function () {",
              "  let present = false;",
              "  try {",
              "    if (j && j.favourite && (j.favourite.sub_id === pm.collectionVariables.get('sub_id') || j.favourite.image_id === pm.collectionVariables.get('image_id'))) present = true;",
              "    if (j && j.vote && (j.vote.sub_id === pm.collectionVariables.get('sub_id') || j.vote.image_id === pm.collectionVariables.get('image_id'))) present = true;",
              "  } catch(e){}",
              "  console.log('include flags present?', present);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "7 - DELETE /favourites/{favourite_id} (cleanup favourite)",
      "request": {
        "method": "DELETE",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/favourites/{{favourite_id}}",
        "description": "Delete the favourite created earlier. If favourite_id is missing, this will likely 404."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "if (!pm.collectionVariables.get('favourite_id')) {",
              "  pm.sendRequest({",
              "    url: pm.collectionVariables.get('endpoint') + '/favourites?sub_id=' + pm.collectionVariables.get('sub_id') + '&limit=50',",
              "    method: 'GET',",
              "    header: { 'x-api-key': pm.collectionVariables.get('x_api_key') }",
              "  }, function(err, res) {",
              "    if (!err && res && res.json && res.json.length>0) {",
              "      let found = res.json().find(it => it.image_id === pm.collectionVariables.get('image_id'));",
              "      if (found) pm.collectionVariables.set('favourite_id', found.id);",
              "    }",
              "  });",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200 or 204 or 404', function () { pm.expect(pm.response.code).to.be.oneOf([200,204,404]); });"
            ]
          }
        }
      ]
    },
    {
      "name": "8 - GET /favourites?sub_id=... (verify favourite removed)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/favourites?sub_id={{sub_id}}&limit=50",
        "description": "Confirm the favourite is no longer present for sub_id."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
              "let arr = pm.response.json();",
              "pm.test('Does not contain deleted favourite image_id', function () {",
              "  let found = arr.some(it => it.image_id === pm.collectionVariables.get('image_id'));",
              "  pm.expect(found).to.be.false;",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "9 - DELETE /votes/{vote_id} (cleanup vote)",
      "request": {
        "method": "DELETE",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/votes/{{vote_id}}",
        "description": "Delete the vote created earlier. If vote_id is missing, attempt to find it by listing votes."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "if (!pm.collectionVariables.get('vote_id')) {",
              "  pm.sendRequest({",
              "    url: pm.collectionVariables.get('endpoint') + '/votes?sub_id=' + pm.collectionVariables.get('sub_id') + '&limit=50',",
              "    method: 'GET',",
              "    header: { 'x-api-key': pm.collectionVariables.get('x_api_key') }",
              "  }, function(err, res) {",
              "    if (!err && res && res.json && res.json.length>0) {",
              "      let found = res.json().find(it => it.image_id === pm.collectionVariables.get('image_id'));",
              "      if (found) pm.collectionVariables.set('vote_id', found.id);",
              "    }",
              "  });",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200 or 204 or 404', function () { pm.expect(pm.response.code).to.be.oneOf([200,204,404]); });"
            ]
          }
        }
      ]
    },
    {
      "name": "10 - GET /votes?sub_id=... (verify vote removed)",
      "request": {
        "method": "GET",
        "header": [
          {"key": "x-api-key", "value": "{{x_api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": "{{endpoint}}/votes?sub_id={{sub_id}}&limit=50",
        "description": "Verify the vote was removed for the sub_id."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
              "let arr = pm.response.json();",
              "pm.test('Does not contain deleted vote for image_id', function () {",
              "  let found = arr.some(it => it.image_id === pm.collectionVariables.get('image_id'));",
              "  pm.expect(found).to.be.false;",
              "});"
            ]
          }
        }
      ]
    }
  ]
}