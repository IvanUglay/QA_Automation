{
  "info": {
    "name": "TheCatAPI - Full Integration Test (images ↔ votes ↔ favourites)",
    "_postman_id": "thecatapi-full-integration",
    "description": "Integration scenario covering images, votes, favourites. Positive and negative tests in one flow. Generated by assistant.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {"key": "endpoint", "value": "https://api.thecatapi.com/v1"},
    {"key": "x_api_key", "value": "DEMO-API-KEY"},
    {"key": "sub_id", "value": "integration-test-user-1234"},
    {"key": "image_id", "value": ""},
    {"key": "favourite_id", "value": ""},
    {"key": "vote_id", "value": ""}
  ],
  "item": [
    {
      "name": "1 - GET /images/search",
      "request": {
        "method": "GET",
        "header": [{"key":"x-api-key","value":"{{x_api_key}}"}],
        "url": "{{endpoint}}/images/search?limit=1",
        "description": "Pick one image id for the integration test"
      },
      "event":[
        {"listen":"test","script":{"exec":[
          "pm.test('Status 200', ()=> pm.response.to.have.status(200));",
          "let json=pm.response.json();",
          "pm.test('At least one image', ()=> pm.expect(json.length).to.be.above(0));",
          "if(json.length>0 && json[0].id) pm.collectionVariables.set('image_id',json[0].id);"
        ]}}
      ]
    },
    {
      "name": "2 - POST /favourites (positive)",
      "request": {
        "method":"POST",
        "header":[{"key":"x-api-key","value":"{{x_api_key}}"},{"key":"Content-Type","value":"application/json"}],
        "body":{"mode":"raw","raw":"{ \"image_id\": \"{{image_id}}\", \"sub_id\": \"{{sub_id}}\" }"},
        "url":"{{endpoint}}/favourites"
      },
      "event":[{"listen":"test","script":{"exec":[
        "pm.test('Status 200/201', ()=> pm.expect(pm.response.code).to.be.oneOf([200,201]));",
        "let j=pm.response.json(); if(j && j.id) pm.collectionVariables.set('favourite_id', j.id);"
      ]}}]
    },
    {
      "name": "3 - POST /votes (positive)",
      "request": {
        "method":"POST",
        "header":[{"key":"x-api-key","value":"{{x_api_key}}"},{"key":"Content-Type","value":"application/json"}],
        "body":{"mode":"raw","raw":"{ \"image_id\": \"{{image_id}}\", \"sub_id\": \"{{sub_id}}\", \"value\": 1 }"},
        "url":"{{endpoint}}/votes"
      },
      "event":[{"listen":"test","script":{"exec":[
        "pm.test('Status 200/201', ()=> pm.expect(pm.response.code).to.be.oneOf([200,201]));",
        "let j=pm.response.json(); if(j && j.id) pm.collectionVariables.set('vote_id', j.id);"
      ]}}]
    },
    {
      "name":"4 - GET /favourites verify",
      "request":{"method":"GET","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/favourites?sub_id={{sub_id}}&limit=50"},
      "event":[{"listen":"test","script":{"exec":[
        "let arr=pm.response.json();",
        "pm.test('Favourite exists', ()=>{let found=arr.some(it=>it.image_id===pm.collectionVariables.get('image_id')); pm.expect(found).to.be.true;});"
      ]}}]
    },
    {
      "name":"5 - GET /votes verify",
      "request":{"method":"GET","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/votes?sub_id={{sub_id}}&limit=50"},
      "event":[{"listen":"test","script":{"exec":[
        "let arr=pm.response.json();",
        "pm.test('Vote exists', ()=>{let found=arr.some(it=>it.image_id===pm.collectionVariables.get('image_id')&&it.value===1); pm.expect(found).to.be.true;});"
      ]}}]
    },
    {
      "name":"6 - GET /images/{image_id} include sub_id",
      "request":{"method":"GET","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/images/{{image_id}}?sub_id={{sub_id}}"},
      "event":[{"listen":"test","script":{"exec":[
        "pm.test('Status 200', ()=> pm.response.to.have.status(200));"
      ]}}]
    },
    {
      "name":"7 - POST /votes negative (non-existent image)",
      "request":{"method":"POST","header":[{"key":"x-api-key","value":"{{x_api_key}}"},{"key":"Content-Type","value":"application/json"}],"body":{"mode":"raw","raw":"{ \"image_id\": \"nonexistent123\", \"sub_id\": \"{{sub_id}}\", \"value\": 1 }"},"url":"{{endpoint}}/votes"},
      "event":[{"listen":"test","script":{"exec":[
        "pm.test('Status 400/404', ()=> pm.expect(pm.response.code).to.be.oneOf([400,404]));",
        "let j=pm.response.json(); pm.test('No vote ID returned', ()=> pm.expect(j.id).to.be.undefined);"
      ]}}]
    },
    {
      "name":"8 - POST /favourites negative (non-existent image)",
      "request":{"method":"POST","header":[{"key":"x-api-key","value":"{{x_api_key}}"},{"key":"Content-Type","value":"application/json"}],"body":{"mode":"raw","raw":"{ \"image_id\": \"nonexistent123\", \"sub_id\": \"{{sub_id}}\" }"},"url":"{{endpoint}}/favourites"},
      "event":[{"listen":"test","script":{"exec":[
        "pm.test('Status 400/404', ()=> pm.expect(pm.response.code).to.be.oneOf([400,404]));",
        "let j=pm.response.json(); pm.test('No favourite ID returned', ()=> pm.expect(j.id).to.be.undefined);"
      ]}}]
    },
    {
      "name":"9 - DELETE /votes cleanup",
      "request":{"method":"DELETE","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/votes/{{vote_id}}"},
      "event":[{"listen":"test","script":{"exec":["pm.test('Status 200/204', ()=> pm.expect(pm.response.code).to.be.oneOf([200,204]));"]}}]
    },
    {
      "name":"10 - DELETE /favourites cleanup",
      "request":{"method":"DELETE","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/favourites/{{favourite_id}}"},
      "event":[{"listen":"test","script":{"exec":["pm.test('Status 200/204', ()=> pm.expect(pm.response.code).to.be.oneOf([200,204]));"]}}]
    },
    {
      "name":"11 - GET /votes verify deletion",
      "request":{"method":"GET","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/votes?sub_id={{sub_id}}&limit=50"},
      "event":[{"listen":"test","script":{"exec":[
        "let arr=pm.response.json();",
        "pm.test('Deleted vote not present', ()=>{let found=arr.some(it=>it.image_id===pm.collectionVariables.get('image_id')); pm.expect(found).to.be.false;});"
      ]}}]
    },
    {
      "name":"12 - GET /favourites verify deletion",
      "request":{"method":"GET","header":[{"key":"x-api-key","value":"{{x_api_key}}"}],"url":"{{endpoint}}/favourites?sub_id={{sub_id}}&limit=50"},
      "event":[{"listen":"test","script":{"exec":[
        "let arr=pm.response.json();",
        "pm.test('Deleted favourite not present', ()=>{let found=arr.some(it=>it.image_id===pm.collectionVariables.get('image_id')); pm.expect(found).to.be.false;});"
      ]}}]
    }
  ]
}
